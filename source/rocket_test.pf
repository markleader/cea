module rocket_test
    use funit
    use cea_rocket
    use cea_equilibrium
    use cea_thermo
    use cea_mixture
    use cea_units
    use cea_param, only: R=>gas_constant, snl=>species_name_len

    type(ThermoDB) :: all_thermo

contains

    @before
    subroutine setup_mixture()
        all_thermo = read_thermo('data/thermo.lib')
    end subroutine

    @test
    subroutine test_rocket8
        type(Mixture) :: products
        type(Mixture) :: reactants
        type(RocketSolver) :: solver
        type(RocketSolution) :: soln
        character(:), allocatable :: product_names(:)
        real(dp) :: hc, pc, weights(2)
        real(dp), parameter :: tol = 1.0d-6

        reactants = Mixture(all_thermo, ['H2(L)', 'O2(L)'])
        product_names = reactants%get_products(all_thermo)
        products = Mixture(all_thermo, product_names)

        weights = reactants%weights_from_of([0.0d0, 1.0d0], [1.0d0, 0.0d0], 5.55157d0)
        hc = reactants%calc_enthalpy(weights, [20.27d0, 90.17d0])/R
        pc = 53.3172d0

        solver = RocketSolver(products, reactants)
        soln = solver%solve(weights, pc, pi_p=[10.0d0], subar=[1.58d0], supar=[25.0d0], hc=hc, fac=.false.)

        ! Products order:  H, H2, H2O, H2O2, HO2, O, O2, O3, OH, H2O(L), H2O(cr)

        ! Test the chamber conditions
        @assertRelativelyEqual(3383.8446259451043d0,  soln%eq_soln(1)%T, tol)
        @assertRelativelyEqual(-5.9391066300902899d0, soln%eq_soln(1)%ln_nj(1), tol)
        @assertRelativelyEqual(-3.7643107135196541d0, soln%eq_soln(1)%ln_nj(2), tol)
        @assertRelativelyEqual(-2.9976630862020173d0, soln%eq_soln(1)%ln_nj(3), tol)
        @assertRelativelyEqual(-14.632985426310452d0, soln%eq_soln(1)%ln_nj(4), tol)
        @assertRelativelyEqual(-13.654509169590025d0, soln%eq_soln(1)%ln_nj(5), tol)
        @assertRelativelyEqual(-8.7241127552322890d0, soln%eq_soln(1)%ln_nj(6), tol)
        @assertRelativelyEqual(-8.9072363130935912d0, soln%eq_soln(1)%ln_nj(7), tol)
        @assertRelativelyEqual(-22.819003969522797d0, soln%eq_soln(1)%ln_nj(8), tol)
        @assertRelativelyEqual(-5.9437893227214982d0, soln%eq_soln(1)%ln_nj(9), tol)
        @assertEqual(0.0d0, soln%eq_soln(1)%nj(10), tol)
        @assertEqual(0.0d0, soln%eq_soln(1)%nj(11), tol)
        @assertRelativelyEqual(1.1446952882630981d0, soln%eq_partials(1)%gamma_s, tol)

        ! Test the throat conditions
        @assertRelativelyEqual(3185.6731730807096d0,  soln%eq_soln(2)%T, 1.d-4)
        @assertRelativelyEqual(-6.1821344716750914d0, soln%eq_soln(2)%ln_nj(1), 1.d-4)
        @assertRelativelyEqual(-3.7758918668469459d0, soln%eq_soln(2)%ln_nj(2), tol)
        @assertRelativelyEqual(-2.9793204768377386d0, soln%eq_soln(2)%ln_nj(3), 1.d-5)
        @assertRelativelyEqual(-15.390957389720871d0, soln%eq_soln(2)%ln_nj(4), 1.d-4)
        @assertRelativelyEqual(-14.463537833879375d0, soln%eq_soln(2)%ln_nj(5), 1.d-3)
        @assertRelativelyEqual(-9.2750622184872977d0, soln%eq_soln(2)%ln_nj(6), 1.d-3)
        @assertRelativelyEqual(-9.4174545784769350d0, soln%eq_soln(2)%ln_nj(7), 1.d-3)
        @assertRelativelyEqual(-24.252028485373366d0, soln%eq_soln(2)%ln_nj(8), 1.d-3)
        @assertRelativelyEqual(-6.2780009788518836d0, soln%eq_soln(2)%ln_nj(9), 1.d-3)
        @assertEqual(0.0d0, soln%eq_soln(1)%nj(10), tol)
        @assertEqual(0.0d0, soln%eq_soln(1)%nj(11), tol)

        ! Test the exit conditions (pi_p)
        @assertRelativelyEqual(2567.3401804441942d0,  soln%eq_soln(3)%T, tol)
        @assertRelativelyEqual(-7.4110702063645491d0, soln%eq_soln(3)%ln_nj(1), tol)
        @assertRelativelyEqual(-3.7880413204534467d0, soln%eq_soln(3)%ln_nj(2), tol)
        @assertRelativelyEqual(-2.9450033504645035d0, soln%eq_soln(3)%ln_nj(3), tol)
        @assertRelativelyEqual(-18.624129018870430d0, soln%eq_soln(3)%ln_nj(4), tol)
        @assertRelativelyEqual(-18.178541272294826d0, soln%eq_soln(3)%ln_nj(5), tol)
        @assertRelativelyEqual(-12.125214188066495d0, soln%eq_soln(3)%ln_nj(6), tol)
        @assertRelativelyEqual(-12.179128247179491d0, soln%eq_soln(3)%ln_nj(7), tol)
        @assertRelativelyEqual(-30.767783000077998d0, soln%eq_soln(3)%ln_nj(8), tol)
        @assertRelativelyEqual(-7.9729277088941561d0, soln%eq_soln(3)%ln_nj(9), tol)
        @assertEqual(0.0d0, soln%eq_soln(3)%nj(10), tol)
        @assertEqual(0.0d0, soln%eq_soln(3)%nj(11), tol)

        ! Test the exit conditions (subar)
        @assertRelativelyEqual(3348.6869671134514d0,  soln%eq_soln(4)%T, 1.d-5)
        @assertRelativelyEqual(-5.9786443891862024d0, soln%eq_soln(4)%ln_nj(1), 1.d-5)
        @assertRelativelyEqual(-3.7666111179114079d0, soln%eq_soln(4)%ln_nj(2), 1.d-5)
        @assertRelativelyEqual(-2.9941914961601874d0, soln%eq_soln(4)%ln_nj(3), 1.d-5)
        @assertRelativelyEqual(-14.760092748145684d0, soln%eq_soln(4)%ln_nj(4), 1.d-5)
        @assertRelativelyEqual(-13.788301982356952d0, soln%eq_soln(4)%ln_nj(5), 1.d-5)
        @assertRelativelyEqual(-8.8130098813248789d0, soln%eq_soln(4)%ln_nj(6), 1.d-5)
        @assertRelativelyEqual(-8.9885170751671950d0, soln%eq_soln(4)%ln_nj(7), 1.d-5)
        @assertRelativelyEqual(-23.056662760647107d0, soln%eq_soln(4)%ln_nj(8), 1.d-5)
        @assertRelativelyEqual(-5.9979245848374543d0, soln%eq_soln(4)%ln_nj(9), 1.d-5)
        @assertEqual(0.0d0, soln%eq_soln(4)%nj(10), tol)
        @assertEqual(0.0d0, soln%eq_soln(4)%nj(11), tol)

        ! Test the exit conditions (supar)
        @assertRelativelyEqual(1468.1562133402410d0,  soln%eq_soln(5)%T, 1.d-4)
        @assertRelativelyEqual(-13.726496941435956d0, soln%eq_soln(5)%ln_nj(1), 1.d-4)
        @assertRelativelyEqual(-3.7830318719581535d0, soln%eq_soln(5)%ln_nj(2), tol)
        @assertRelativelyEqual(-2.9381766200877317d0, soln%eq_soln(5)%ln_nj(3), tol)
        @assertRelativelyEqual(-31.274332478224157d0, soln%eq_soln(5)%ln_nj(4), 1.d-4)
        @assertRelativelyEqual(-34.437819507855693d0, soln%eq_soln(5)%ln_nj(5), 1.d-4)
        @assertRelativelyEqual(-26.622750111744118d0, soln%eq_soln(5)%ln_nj(6), 1.d-4)
        @assertRelativelyEqual(-26.534772500074840d0, soln%eq_soln(5)%ln_nj(7), 1.d-4)
        @assertRelativelyEqual(-59.126801668300317d0, soln%eq_soln(5)%ln_nj(8), 1.d-4)
        @assertRelativelyEqual(-16.379625717865014d0, soln%eq_soln(5)%ln_nj(9), 1.d-4)
        @assertEqual(0.0d0, soln%eq_soln(5)%nj(10), tol)
        @assertEqual(0.0d0, soln%eq_soln(5)%nj(11), tol)

    end subroutine

    @test
    subroutine test_rocket8_pt2
        type(Mixture) :: products
        type(Mixture) :: reactants
        type(RocketSolver) :: solver
        type(RocketSolution) :: soln
        character(:), allocatable :: product_names(:)
        real(dp) :: hc, pc, weights(2)
        real(dp), parameter :: tol = 1.0d-6

        reactants = Mixture(all_thermo, ['H2(L)', 'O2(L)'])
        product_names = reactants%get_products(all_thermo)
        products = Mixture(all_thermo, product_names)

        weights = reactants%weights_from_of([0.0d0, 1.0d0], [1.0d0, 0.0d0], 5.55157d0)
        hc = reactants%calc_enthalpy(weights, [20.27d0, 90.17d0])/R
        pc = 53.3172d0

        solver = RocketSolver(products, reactants)
        soln = solver%solve(weights, pc, pi_p=[1000.0d0], subar=[1.58d0], supar=[75.0d0], hc=hc, fac=.false.)

        ! Products order:  H, H2, H2O, H2O2, HO2, O, O2, O3, OH, H2O(L), H2O(cr)

        ! Test the exit conditions (pi_p)
        @assertRelativelyEqual(1115.8672540067198d0,  soln%eq_soln(3)%T, tol)
        @assertRelativelyEqual(-18.839699340767350d0, soln%eq_soln(3)%ln_nj(1), tol)
        @assertRelativelyEqual(-3.7830096883727244d0, soln%eq_soln(3)%ln_nj(2), tol)
        @assertRelativelyEqual(-2.9381751664806930d0, soln%eq_soln(3)%ln_nj(3), tol)
        @assertRelativelyEqual(-40.503413783116436d0, soln%eq_soln(3)%ln_nj(4), tol)
        @assertRelativelyEqual(-46.869172917775650d0, soln%eq_soln(3)%ln_nj(5), tol)
        @assertRelativelyEqual(-38.281922029498190d0, soln%eq_soln(3)%ln_nj(6), tol)
        @assertRelativelyEqual(-38.084632640515693d0, soln%eq_soln(3)%ln_nj(7), tol)
        @assertRelativelyEqual(-80.850362530030438d0, soln%eq_soln(3)%ln_nj(8), tol)
        @assertRelativelyEqual(-23.086079344392509d0, soln%eq_soln(3)%ln_nj(9), tol)
        @assertEqual(0.0d0, soln%eq_soln(3)%nj(10), tol)
        @assertEqual(0.0d0, soln%eq_soln(3)%nj(11), tol)

        ! Test the exit conditions (supar)
        @assertRelativelyEqual(1088.6397265231828d0,  soln%eq_soln(5)%T, 1.d-4)
        @assertRelativelyEqual(-19.382439807170922d0, soln%eq_soln(5)%ln_nj(1), 1.d-4)
        @assertRelativelyEqual(-3.7830096278414955d0, soln%eq_soln(5)%ln_nj(2), tol)
        @assertRelativelyEqual(-2.9381751664807116d0, soln%eq_soln(5)%ln_nj(3), tol)
        @assertRelativelyEqual(-41.461231562555369d0, soln%eq_soln(5)%ln_nj(4), 1.d-4)
        @assertRelativelyEqual(-48.173268381760458d0, soln%eq_soln(5)%ln_nj(5), 1.d-4)
        @assertRelativelyEqual(-39.517963084485800d0, soln%eq_soln(5)%ln_nj(6), 1.d-4)
        @assertRelativelyEqual(-39.308395842814186d0, soln%eq_soln(5)%ln_nj(7), 1.d-4)
        @assertRelativelyEqual(-83.130329931243125d0, soln%eq_soln(5)%ln_nj(8), 1.d-4)
        @assertRelativelyEqual(-23.795862410526230d0, soln%eq_soln(5)%ln_nj(9), 1.d-4)
        @assertEqual(0.0d0, soln%eq_soln(5)%nj(10), tol)
        @assertEqual(0.0d0, soln%eq_soln(5)%nj(11), tol)

    end subroutine

    @test
    subroutine test_rocket9
        type(Mixture) :: products
        type(Mixture) :: reactants
        type(RocketSolver) :: solver
        type(RocketSolution) :: soln
        character(:), allocatable :: product_names(:)
        real(dp) :: hc, pc, weights(2)
        real(dp), parameter :: tol = 1.0d-6

        reactants = Mixture(all_thermo, ['H2(L)', 'O2(L)'])
        product_names = reactants%get_products(all_thermo)
        products = Mixture(all_thermo, product_names)

        weights = reactants%weights_from_of([0.0d0, 1.0d0], [1.0d0, 0.0d0], 5.55157d0)
        hc = reactants%calc_enthalpy(weights, [20.27d0, 90.17d0])/R
        pc = 53.3172d0

        solver = RocketSolver(products, reactants)
        soln = solver%solve(weights, pc, pi_p=[10.0d0], ac_at=1.58d0, supar=[25.0d0], hc=hc, fac=.true.)

        ! Products order:  H, H2, H2O, H2O2, HO2, O, O2, O3, OH, H2O(L), H2O(cr)

        ! Test the injector conditions
        @assertRelativelyEqual(3383.8446259451043d0,  soln%eq_soln(1)%T, tol)
        @assertRelativelyEqual(-5.9391066300902899d0, soln%eq_soln(1)%ln_nj(1), tol)
        @assertRelativelyEqual(-3.7643107135196541d0, soln%eq_soln(1)%ln_nj(2), tol)
        @assertRelativelyEqual(-2.9976630862020173d0, soln%eq_soln(1)%ln_nj(3), tol)
        @assertRelativelyEqual(-14.632985426310452d0, soln%eq_soln(1)%ln_nj(4), tol)
        @assertRelativelyEqual(-13.654509169590025d0, soln%eq_soln(1)%ln_nj(5), tol)
        @assertRelativelyEqual(-8.7241127552322890d0, soln%eq_soln(1)%ln_nj(6), tol)
        @assertRelativelyEqual(-8.9072363130935912d0, soln%eq_soln(1)%ln_nj(7), tol)
        @assertRelativelyEqual(-22.819003969522797d0, soln%eq_soln(1)%ln_nj(8), tol)
        @assertRelativelyEqual(-5.9437893227214982d0, soln%eq_soln(1)%ln_nj(9), tol)
        @assertEqual(0.0d0, soln%eq_soln(1)%nj(10))
        @assertEqual(0.0d0, soln%eq_soln(1)%nj(11))
        @assertRelativelyEqual(1.1446952882630981d0, soln%eq_partials(1)%gamma_s, tol)

        ! Test the combustor end conditions
        @assertRelativelyEqual(3341.0778981354892d0,  soln%eq_soln(3)%T, 1.d-4)
        @assertRelativelyEqual(-5.9563043802997306d0, soln%eq_soln(3)%ln_nj(1), 1.d-4)
        @assertRelativelyEqual(-3.7662871638072399d0, soln%eq_soln(3)%ln_nj(2), 1.d-4)
        @assertRelativelyEqual(-2.9953231345416889d0, soln%eq_soln(3)%ln_nj(3), 1.d-4)
        @assertRelativelyEqual(-14.792564445649031d0, soln%eq_soln(3)%ln_nj(4), 1.d-4)
        @assertRelativelyEqual(-13.792063684573417d0, soln%eq_soln(3)%ln_nj(5), 1.d-4)
        @assertRelativelyEqual(-8.7740364834084108d0, soln%eq_soln(3)%ln_nj(6), 1.d-3)
        @assertRelativelyEqual(-8.9505957454432306d0, soln%eq_soln(3)%ln_nj(7), 1.d-3)
        @assertRelativelyEqual(-23.055677849103546d0, soln%eq_soln(3)%ln_nj(8), 1.d-4)
        @assertRelativelyEqual(-5.9815107001626036d0, soln%eq_soln(3)%ln_nj(9), 1.d-4)
        @assertEqual(0.0d0, soln%eq_soln(3)%nj(10))
        @assertEqual(0.0d0, soln%eq_soln(3)%nj(11))

        ! Test the throat conditions
        @assertRelativelyEqual(3179.8427699021822d0,  soln%eq_soln(4)%T, 1.d-3)
        @assertRelativelyEqual(-6.1578021043083115d0, soln%eq_soln(4)%ln_nj(1), 1.d-3)
        @assertRelativelyEqual(-3.7756980710176986d0, soln%eq_soln(4)%ln_nj(2), 1.d-5)
        @assertRelativelyEqual(-2.9802599107644063d0, soln%eq_soln(4)%ln_nj(3), 1.d-5)
        @assertRelativelyEqual(-15.419598173067183d0, soln%eq_soln(4)%ln_nj(4), 1.d-3)
        @assertRelativelyEqual(-14.462086820578048d0, soln%eq_soln(4)%ln_nj(5), 1.d-3)
        @assertRelativelyEqual(-9.2312248450453414d0, soln%eq_soln(4)%ln_nj(6), 1.d-3)
        @assertRelativelyEqual(-9.3743822276749569d0, soln%eq_soln(4)%ln_nj(7), 1.d-3)
        @assertRelativelyEqual(-24.241251098542243d0, soln%eq_soln(4)%ln_nj(8), 1.d-3)
        @assertRelativelyEqual(-6.2588057507354531d0, soln%eq_soln(4)%ln_nj(9), 1.d-3)
        @assertEqual(0.0d0, soln%eq_soln(4)%nj(10))
        @assertEqual(0.0d0, soln%eq_soln(4)%nj(11))

        ! Test the exit conditions (supar)
        @assertRelativelyEqual(1469.5862790545111d0,  soln%eq_soln(6)%T, 1.d-3)
        @assertRelativelyEqual(-13.668812957083835d0, soln%eq_soln(6)%ln_nj(1), 1.d-2)
        @assertRelativelyEqual(-3.7830331890555100d0, soln%eq_soln(6)%ln_nj(2), tol)
        @assertRelativelyEqual(-2.9381767139263322d0, soln%eq_soln(6)%ln_nj(3), tol)
        @assertRelativelyEqual(-31.245760599708980d0, soln%eq_soln(6)%ln_nj(4), 1.d-3)
        @assertRelativelyEqual(-34.357542401748269d0, soln%eq_soln(6)%ln_nj(5), 1.d-3)
        @assertRelativelyEqual(-26.503010331351341d0, soln%eq_soln(6)%ln_nj(6), 1.d-2)
        @assertRelativelyEqual(-26.415348318785043d0, soln%eq_soln(6)%ln_nj(7), 1.d-2)
        @assertRelativelyEqual(-58.975898064884383d0, soln%eq_soln(6)%ln_nj(8), 1.d-3)
        @assertRelativelyEqual(-16.317067642119419d0, soln%eq_soln(6)%ln_nj(9), 1.d-3)
        @assertEqual(0.0d0, soln%eq_soln(6)%nj(10))
        @assertEqual(0.0d0, soln%eq_soln(6)%nj(11))

        ! Test the exit conditions (pi_p)
        @assertRelativelyEqual(2595.0889748454247d0,  soln%eq_soln(5)%T, 1.d-2)
        @assertRelativelyEqual(-7.2961784801543654d0, soln%eq_soln(5)%ln_nj(1), 1.d-2)
        @assertRelativelyEqual(-3.7882991974622957d0, soln%eq_soln(5)%ln_nj(2), 1.d-4)
        @assertRelativelyEqual(-2.9460954339752519d0, soln%eq_soln(5)%ln_nj(3), 1.d-4)
        @assertRelativelyEqual(-18.443900219693734d0, soln%eq_soln(5)%ln_nj(4), 1.d-3)
        @assertRelativelyEqual(-17.923270161497687d0, soln%eq_soln(5)%ln_nj(5), 1.d-2)
        @assertRelativelyEqual(-11.870686602436889d0, soln%eq_soln(5)%ln_nj(6), 1.d-2)
        @assertRelativelyEqual(-11.927637492340260d0, soln%eq_soln(5)%ln_nj(7), 1.d-2)
        @assertRelativelyEqual(-30.311703613188691d0, soln%eq_soln(5)%ln_nj(8), 1.d-2)
        @assertRelativelyEqual(-7.8301565282584225d0, soln%eq_soln(5)%ln_nj(9), 1.d-3)
        @assertEqual(0.0d0, soln%eq_soln(5)%nj(10))
        @assertEqual(0.0d0, soln%eq_soln(5)%nj(11))

    end subroutine

    @test
    subroutine test_rocket_frozen
        ! RP-1311 Example 12
        type(Mixture) :: products
        type(Mixture) :: reactants
        type(RocketSolver) :: solver
        type(RocketSolution) :: soln
        character(:), allocatable :: product_names(:)
        real(dp) :: hc, pc, weights(2)
        real(dp), parameter :: tol = 1.0d-6

        product_names = ['CO    ', 'CO2   ', 'H     ', 'HNO   ', 'HNO2  ', 'HO2   ', 'H2    ', &
                         'H2O   ', 'H2O2  ', 'N     ', 'NO    ', 'NO2   ', 'N2    ', 'N2O   ', &
                         'O     ', 'OH    ', 'O2    ', 'HCO   ', 'NH    ', 'CH4   ', 'NH2   ', &
                         'NH3   ', 'H2O(L)', 'C(gr) ']
        reactants = Mixture(all_thermo, ['CH6N2(L)', 'N2O4(L) '])
        products = Mixture(all_thermo, product_names)

        weights = reactants%weights_from_of([0.0d0, 1.0d0], [1.0d0, 0.0d0], 2.5d0)
        hc = reactants%calc_enthalpy(weights, 298.15d0)/R
        pc = 68.947304458095616d0

        solver = RocketSolver(products, reactants)
        soln = solver%solve(weights, pc, pi_p=[68.0457d0], supar=[5.0d0], hc=hc, fac=.false., n_frz=2)

        ! Test the exit conditions
        @assertRelativelyEqual(3382.3181144076229d0,  soln%eq_soln(1)%T, tol)
        @assertRelativelyEqual(68.947304458095616d0,  soln%pressure(1), tol)

        @assertRelativelyEqual(3203.6736975694471d0,  soln%eq_soln(2)%T, tol)
        @assertRelativelyEqual(39.813550688339767d0,  soln%pressure(2), 1.d-5)

        @assertRelativelyEqual(1627.6780737328247d0,  soln%eq_soln(3)%T, 1.d-5)
        @assertRelativelyEqual(1.0132499843207670d0,  soln%pressure(3), tol)

        @assertRelativelyEqual(1868.5246882548397d0,  soln%eq_soln(4)%T, 1.d-5)
        @assertRelativelyEqual(2.0681622287672528d0,  soln%pressure(4), 1.d-4)

    end subroutine

end module